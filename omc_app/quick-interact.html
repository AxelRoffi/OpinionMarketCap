<!DOCTYPE html>
<html>
<head>
    <title>OpinionCore Contract Interface</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.esm.min.js" type="module"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        input { padding: 5px; margin: 5px; width: 200px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>OpinionCore Contract Interface</h1>
    <p>Contract: 0xC47bFEc4D53C51bF590beCEA7dC935116E210E97 (Base Mainnet)</p>
    
    <button id="connect">üîó Connect Wallet</button>
    <div id="account"></div>

    <div id="interface" style="display:none;">
        <div class="section">
            <h2>üìñ Read Functions</h2>
            <button onclick="callRead('nextOpinionId')">nextOpinionId()</button>
            <button onclick="callRead('isPublicCreationEnabled')">isPublicCreationEnabled()</button>
            <button onclick="callRead('minimumPrice')">minimumPrice()</button>
            <button onclick="callRead('treasury')">treasury()</button>
            <button onclick="callRead('questionCreationFee')">questionCreationFee()</button>
            <button onclick="callRead('creationFeePercent')">creationFeePercent()</button>
            <button onclick="getOpinion()">getOpinionDetails(id)</button>
            <input type="number" id="opinionId" placeholder="Opinion ID" value="1">
            <div id="readResult" class="result"></div>
        </div>

        <div class="section">
            <h2>‚úèÔ∏è Write Functions</h2>
            <h3>Admin Functions</h3>
            <button onclick="callWrite('togglePublicCreation')">togglePublicCreation()</button>
            <button onclick="callWrite('pause')">pause()</button>
            <button onclick="callWrite('unpause')">unpause()</button>
            
            <h3>Set Parameter</h3>
            <select id="paramType">
                <option value="0">0 - minimumPrice</option>
                <option value="3">3 - absoluteMaxPriceChange</option>
                <option value="4">4 - maxTradesPerBlock</option>
                <option value="6">6 - questionCreationFee</option>
                <option value="7">7 - initialAnswerPrice</option>
                <option value="14">14 - creationFeePercent</option>
            </select>
            <input type="number" id="paramValue" placeholder="Value">
            <button onclick="setParameter()">setParameter()</button>
            
            <div id="writeResult" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdn.ethers.io/lib/ethers-5.7.2.esm.min.js";
        
        const CONTRACT_ADDRESS = "0xC47bFEc4D53C51bF590beCEA7dC935116E210E97";
        const ABI = [
            "function nextOpinionId() view returns (uint256)",
            "function isPublicCreationEnabled() view returns (bool)",
            "function minimumPrice() view returns (uint96)",
            "function treasury() view returns (address)",
            "function questionCreationFee() view returns (uint96)",
            "function creationFeePercent() view returns (uint256)",
            "function getOpinionDetails(uint256) view returns (tuple(uint96 lastPrice, uint96 nextPrice, uint96 totalVolume, uint96 salePrice, address creator, address questionOwner, address currentAnswerOwner, bool isActive, string question, string currentAnswer, string currentAnswerDescription, string ipfsHash, string link, string[] categories))",
            "function togglePublicCreation()",
            "function pause()",
            "function unpause()",
            "function setParameter(uint8 paramType, uint256 value)"
        ];
        
        let provider, signer, contract, readContract;
        
        document.getElementById('connect').onclick = async () => {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                
                const address = await signer.getAddress();
                const network = await provider.getNetwork();
                
                document.getElementById('account').innerHTML = `Connected: ${address} (Chain ID: ${network.chainId})`;
                document.getElementById('interface').style.display = 'block';
                
                if (network.chainId !== 8453) {
                    alert('Please switch to Base Mainnet (Chain ID: 8453)');
                }
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }
        
        window.callRead = async (funcName) => {
            try {
                const result = await readContract[funcName]();
                let formatted = result.toString();
                
                if (funcName === 'minimumPrice' || funcName === 'questionCreationFee') {
                    formatted = ethers.utils.formatUnits(result, 6) + ' USDC';
                }
                
                document.getElementById('readResult').innerHTML = 
                    `<span class="success">${funcName}(): ${formatted}</span>`;
            } catch (error) {
                document.getElementById('readResult').innerHTML = 
                    `<span class="error">Error: ${error.message}</span>`;
            }
        }
        
        window.getOpinion = async () => {
            try {
                const id = document.getElementById('opinionId').value;
                const result = await readContract.getOpinionDetails(id);
                
                const formatted = {
                    question: result.question,
                    currentAnswer: result.currentAnswer,
                    lastPrice: ethers.utils.formatUnits(result.lastPrice, 6) + ' USDC',
                    nextPrice: ethers.utils.formatUnits(result.nextPrice, 6) + ' USDC',
                    creator: result.creator,
                    currentOwner: result.currentAnswerOwner,
                    isActive: result.isActive
                };
                
                document.getElementById('readResult').innerHTML = 
                    `<span class="success">Opinion #${id}:<br>${JSON.stringify(formatted, null, 2)}</span>`;
            } catch (error) {
                document.getElementById('readResult').innerHTML = 
                    `<span class="error">Error: ${error.message}</span>`;
            }
        }
        
        window.callWrite = async (funcName) => {
            try {
                const tx = await contract[funcName]();
                document.getElementById('writeResult').innerHTML = 
                    `Transaction sent: <a href="https://basescan.org/tx/${tx.hash}" target="_blank">${tx.hash}</a>`;
                await tx.wait();
                document.getElementById('writeResult').innerHTML += 
                    '<br><span class="success">‚úÖ Transaction confirmed!</span>';
            } catch (error) {
                document.getElementById('writeResult').innerHTML = 
                    `<span class="error">Error: ${error.message}</span>`;
            }
        }
        
        window.setParameter = async () => {
            try {
                const paramType = document.getElementById('paramType').value;
                const value = document.getElementById('paramValue').value;
                
                const tx = await contract.setParameter(paramType, value);
                document.getElementById('writeResult').innerHTML = 
                    `Transaction sent: <a href="https://basescan.org/tx/${tx.hash}" target="_blank">${tx.hash}</a>`;
                await tx.wait();
                document.getElementById('writeResult').innerHTML += 
                    '<br><span class="success">‚úÖ Parameter updated!</span>';
            } catch (error) {
                document.getElementById('writeResult').innerHTML = 
                    `<span class="error">Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>